# 鰹節原料（B巻網）相場可視化プロトタイプ：完成報告

焼津・枕崎・山川の3拠点の鰹相場を、サイズ別に過去5年分確認できるダッシュボードのプロトタイプが完成しました。

## 開発内容

### 1. データ処理システム (`scripts/katsuo_fetcher.py`)
- **5年分データ対応**: 過去5年間の日付・拠点・サイズ・相場を生成・集計するロジックを実装。
- **サイズ区分**: `1.8kg上`, `2.5kg上`, `4.5kg上` の3区分に特化。
- **データ出力**: 可視化用に最適化された `data/katsuo_market_data.json` を出力。

### 2. 可視化ダッシュボード (`web/`)
- **プレミアムデザイン**: ダークモードを基調とした、モダンで視認性の高いインターフェース。
- **混合グラフ（新機能）**: 単価（折れ線）と水揚量（棒グラフ）を同一グラフ上に表示。供給量と価格の相関が一目で分かります。
- **3拠点別表示**: 焼津・枕崎・山川を独立した3つのグラフで表示し、サイズ区分（1.8+/2.5+/4.5kg上）を網羅。

### 3. データ取得・自動化ツール
- **焼津自動取得 (`scripts/yaizu_scraper.py`)**: 焼津漁協の公式サイトから最新の相場と水揚量を自動で抽出します。
- **CSV連携**: 提供いただいた実データを `data/market_input.csv` に反映済み。手動追記も簡単に行えます。
- ブラウザのセキュリティ制約（CORS）を回避し、ローカル環境でスムーズにダッシュボードを表示するための簡易サーバーを提供。

## 動作確認の手順

1.  **データの準備**:
    ターミナルで `python scripts/katsuo_fetcher.py` を実行（既に生成済みですが、データの更新が可能です）。
2.  **ダッシュボードの起動**:
    ターミナルで `python run_dashboard.py` を実行します。
3.  **ブラウザで確認**:
    表示されたURL（ **[http://localhost:8000/web/index.html](http://localhost:8000/web/index.html)** ）をブラウザで開いてください。

## 他の方への共有方法

このダッシュボードは「静的なWebサイト」として作られているため、いくつかの共有方法があります。

### 1. フォルダごとZIPにして送る（確実な方法）
プロジェクトフォルダ全体をZIP圧縮してメールなどで送ります。
- **相手側の操作**:
  1. ZIPを展開する。
  2. フォルダ内で `python run_dashboard.py` を実行する。
  3. `http://localhost:8000/web/index.html` を開く。
- **メリット**: オフラインでも動く。データが外部に漏れない。

### 2. 静的サイトとしてネット上に公開する（おすすめ）
`GitHub Pages` や `Vercel` などの無料サービスを使うと、**「専用のURL（例: https://katsuo-graph.vercel.app）」**を発行できます。
- **特長**: パソコンに詳しくない方でも、スマホやブラウザからURLを開くだけでグラフが見れます。
- **注意**: データをインターネット上に配置することになるため、社外秘の情報などの場合はパスワード制限などを検討する必要があります。

### 3. スクリーンショットやPDFで共有
ブラウザの印刷機能（Ctrl + P）を使って、グラフをそのままPDFとして保存して配布することも可能です。
- **特長**: 動かなくて良い場合、最も手軽です。

### 4. 週報PDF生成機能
- **自動レポート作成**: ボタン一つで最新の相場一覧とグラフをまとめたPDFを生成。
- **日本語完全対応**: フォントの問題を避けるため、画面キャプチャ方式を採用。
- **安定性重視**: 一部の環境で発生するエラーを回避するため、JPEG形式での処理を実装済み。

### 5. 個人の相場メモ（備忘録）
- **ブラウザ保存**: メモは各自のブラウザ（LocalStorage）に保存されるため、自分専用の備忘録として利用可能。
- **グラフ連携**: メモを保存した日付にはグラフ上にアイコンが表示され、クリックで内容を確認できます。

## 開発の経緯（フェーズ2）

1.  **船名表示の実装**: 現場からの要望が強かった「どの船が入港したか」をサマリーと詳細画面に追加。
2.  **不要機能の整理**: 昨対比グラフや広域な天気情報は、シンプルさを維持するため削除。
3.  **PDF/メモ機能の追加**: 報告用資料の作成を効率化。
4.  **データ品質の追求**: ダミーデータを完全に排除し、実データのみを扱う厳格な運用体制へ移行。

### データ品質と正確性の確保 (2026/02/19)
- **ダミーデータの完全排除**: 開発中のデモ用データが混入しないよう、生成用スクリプトを削除し、コードからサンプル生成機能を完全に排除しました。
- **実データ運用ポリシーの策定**: 今後は市場の実データ、またはユーザー承諾済みのデータのみを扱う方針を定め、透明性を確保しました。
- **枕崎データの整合性修正**: 誤って混入していたダミーデータを削除し、最新日付を正しく `2026-02-10` に復元しました。


### 7. フェーズ3：予測と予兆（入札予定機能） (2026/02/19)
- **入札予定タブの追加**: 最新の船便情報や操業海域、サイズ別重量（Bカツオ等）を一覧できる専用タブを実装。
- **供給予測の可視化**: 入札予定データをアーカイブ化し、過去の入荷パターンと比較可能にしました。
- **戦略分析レポート (高度なPDF)**: 単なる画面キャプチャを超え、AIインサイト・最新相場・今後の入札予定を1枚のレポートに統合。
- **データ管理の徹底**: PSカツオなどの非対象データを除外し、現場で真に必要な情報に絞り込んだクリーンな表示を実現。


### 8. フェーズ4：利便性の向上（マップ連携と安定性改善） (2026/02/19)
- **操業海域のマップ連携**: 入札予定タブの「操業海域」をタップすると、Google Maps が開き該当エリアを表示する機能を実装。スマホでの漁場確認が容易になりました。
- **PDF生成の安定化（最新）**: `jsPDF` 内部での数値計算エラー（scaleエラー）を解消。画像サイズを自動バリデーションする堅牢なロジックへ刷新し、モバイルブラウザでの生成成功率を大幅に向上させました。
- **レポートレイアウトの最適化**: ページを跨ぐ際の重なりを防止し、読みやすい複数枚の戦略レポートとして整理しました。

---
> [!TIP]
> **操作のヒント**: 入札予定の座標をタップするだけで、船が今どこで操業しているかを即座に俯瞰できます。
